@startuml
title Diagrama de Secuencia - Evaluación Postfix "1 2 + 4 * 3 +" (Versión Corregida)

actor Usuario
participant ":Main" as Main
participant ":Parser" as Parser
participant ":Calculator" as Calculator
participant ":Stack<Token>" as Stack

Usuario -> Main: main(args)
activate Main

Main -> Main: new Main()
note right: Crea instancia con\nStackArrayList por defecto

Main -> Usuario: Mostrar menú de selección
Usuario -> Main: Seleccionar implementación\n(1: ArrayList, 2: Array)
Main -> Main: setStackImplementation(stack)
note right: Configura implementación\nde pila según selección

Main -> Main: processFile("datos.txt")
Main -> Main: readFile("datos.txt")
note right: Lee todas las líneas\ndel archivo

loop cada línea del archivo
    Main -> Main: operate("1 2 + 4 * 3 +")

    == Fase 1: Parseo ==
    Main -> Parser: new Parser()
    activate Parser
    Main -> Parser: parse("1 2 + 4 * 3 +")

    loop cada elemento separado por espacio
        Parser -> Parser: identificar tipo (OPERAND/OPERATOR)
        Parser -> Parser: crear Token(type, value)
    end
    Parser --> Main: List<Token>
    deactivate Parser

    == Fase 2: Evaluación ==
    Main -> Stack: new Stack<Token>()
    activate Stack
    note right: Crea nueva instancia\npara esta operación

    Main -> Calculator: new Calculator(stack)
    activate Calculator
    Main -> Calculator: operate(tokens)

    note over Calculator, Stack
      Tokens: [1, 2, +, 4, *, 3, +]
    end note

    Calculator -> Stack: push(Token("OPERAND","1"))
    note right of Stack: [1]

    Calculator -> Stack: push(Token("OPERAND","2"))
    note right of Stack: [1, 2]

    Calculator -> Stack: pop()
    Stack --> Calculator: Token("OPERAND","2")
    Calculator -> Stack: pop()
    Stack --> Calculator: Token("OPERAND","1")
    Calculator -> Calculator: 1 + 2 = 3
    Calculator -> Stack: push(Token("OPERAND","3"))
    note right of Stack: [3]

    Calculator -> Stack: push(Token("OPERAND","4"))
    note right of Stack: [3, 4]

    Calculator -> Stack: pop()
    Stack --> Calculator: Token("OPERAND","4")
    Calculator -> Stack: pop()
    Stack --> Calculator: Token("OPERAND","3")
    Calculator -> Calculator: 3 * 4 = 12
    Calculator -> Stack: push(Token("OPERAND","12"))
    note right of Stack: [12]

    Calculator -> Stack: push(Token("OPERAND","3"))
    note right of Stack: [12, 3]

    Calculator -> Stack: pop()
    Stack --> Calculator: Token("OPERAND","3")
    Calculator -> Stack: pop()
    Stack --> Calculator: Token("OPERAND","12")
    Calculator -> Calculator: 12 + 3 = 15
    Calculator -> Stack: push(Token("OPERAND","15"))
    note right of Stack: [15]

    Calculator -> Stack: pop()
    Stack --> Calculator: Token("OPERAND","15")
    note right of Stack: []

    Calculator -> Stack: pop()
    Stack --> Calculator: IllegalArgumentException\n(stack vacío - correcto)

    Calculator --> Main: 15.0
    deactivate Calculator
    deactivate Stack

    Main --> Usuario: "Line 1: 1 2 + 4 * 3 + = 15.0"
end

deactivate Main

@enduml
